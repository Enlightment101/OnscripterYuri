# Onscripter (Yuri)  

![web-onscripter](https://img.shields.io/badge/web-onscripter-green)  

☘️ An ehancement Onscripter porting to many platforms, especially **web** ！
This is base on [ONScripter-Jh](https://github.com/jh10001/ONScripter-Jh) by `SDL2`.

New features or plans:  

- develop
  - [x] clear camke project structure
  - [x] scripts to build without pain
  - [x] vscode project for multi enviroment
  - [ ] ci in github action to automaticly build  
- platform
  - [x] windows by mingw32, mingw64
  - [ ] linux x64
  - [ ] linux aarch64 (raspberrypi)
  - [x] web (support save in indexdb, lazy load (not finished yet), lua)
  - [ ] android
  - [x] psv, see [psv-Onscripter](https://github.com/YuriSizuku/psv-OnscripterJH)
- render
  - [x] support fullscreen by `--fullscreen` or `alt+enter`, scretch to fullscreen by `--fullscreen2` or `f11`  
  - [x] support arbitary resolution `--width`, `--height`  
  - [ ] video support
- other
  - [x] support `nt2`, `nt3` encryption format by Mine
  - [x] support long click or touch to invoke menu  
  - [x] fix some bugs in origin version (can not read `00.txt` problem)  

![onsyuri_webtest_mo2](screenshot/onsyuri_mo2_webtest.png)

## 1. usage

### (1) command

``` bash
./ons_yuri --help
./ons_yuri --root /path/to/game --save-dir /path/to/save --font /path/default.ttf
./ons_yuri --width 1280 --height 720 --enc:sjis
./ons_yuri --fullscreen2 # fullscreen1 alt+f4, fullscreen2 f11
```

❗ If you force exit the game, the save might be damaged, try to remvoe envdata to play again.

### (2) web

This project can run in a browser through hosted web server.  
Press `F11` to strech full in a webpage, long click (touch also) to invoke game menu.
It might need some time to load at first without lazyload now.  

The structure is as bellow:  

``` bash
onsyuri.html
onsyuri.js
onsyuri.wasm
onsyuri_index.json
[your game files]

```

It will load the game according to `onsyuri_index.json`, whitch is deifned by `<meta onsyuri_index="onsyuri_index.json">` in `onsyuri.html`.  

``` json
{
  "title": "game1",
  "gamedir": "/onsyuri/game1",
  "savedir": "/onsyuri_save/game1",
  "args", [],
  "files":[
    {"path": "0.txt" , "url":"http://localhost:5500/asset/test/0.txt"},
    {"path": "bgm/bgm.ogg" , "url":"http://localhost:5500/asset/test/bgm/bgm.ogg"},
    {"path": "default.ttf" , "url":"http://localhost:5500/asset/test/default.ttf"}
  ]
}

```

This can be generated by `onsyuri_index.py`.

## 2. build

### (1) local mingw  

Install the enviroment in msys

``` sh
pacman -Syu --noconfirm
pacman -S --noconfirm make tar vim curl # util tools
pacman -S --noconfirm mingw-w64-x86_64-binutils mingw-w64-x86_64-gcc mingw-w64-x86_64-gdb # mingw64 compile tool
pacman -S --noconfirm mingw-w64-i686-binutils mingw-w64-i686-gcc mingw-w64-i686-gdb # mingw32 compile tool

pacman -S --noconfirm mingw-w64-i686-SDL2 mingw-w64-x86_64-SDL2
pacman -S --noconfirm mingw-w64-i686-SDL2_image mingw-w64-x86_64-SDL2_image
pacman -S --noconfirm mingw-w64-i686-SDL2_ttf mingw-w64-x86_64-SDL2_ttf
pacman -S --noconfirm mingw-w64-i686-SDL2_mixer mingw-w64-x86_64-SDL2_mixer

pacman -S --noconfirm mingw-w64-i686-brotli mingw-w64-x86_64-brotli
pacman -S --noconfirm mingw-w64-i686-mesa mingw-w64-x86_64-mesa
pacman -S --noconfirm mingw-w64-i686-lua mingw-w64-x86_64-lua
```

and then use these `local_mingw32.sh` to build.

``` sh
cd script
sh -c "export BUILD_TYPE=Debug && export MSYS2SDK=/path/to/msys2 && ./local_mingw32.sh"
```

### (2) local linux x64

### (3) cross web  

Install [emsdk](https://github.com/emscripten-core/emsdk) and use `cross_web.sh` to build.  

``` shell
cd script
sh -c "export BUILD_TYPE=Debug && export EMCSDK=/d/Software/env/sdk/emsdk && ./cross_web.sh"
```

### (4) cross linux aarch64

### (5) cross mingw

## 3. compatibility  

|game|version|status|description|
|----|-------|------|-----------|

## 4. knowed issues (including already solved)  

- general  
- windows  
- linux  
- web  
  - [ ] lazy load in workerfs not work, see this [issue](https://github.com/emscripten-core/emscripten/issues/18698)  
