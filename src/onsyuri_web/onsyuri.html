<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta onsyuri_index="onsyuri_index.json">
        <title>Onscripter (yuri)</title>
    </head>
    <body style="margin: 0 auto; background-color:black;">
        <canvas id="canvas" oncontextmenu="event.preventDefault()" style="margin: 0 auto; display: block;"></canvas>
        <script src="onsyuri.js" type="text/javascript"></script>
        <!-- <script src="onsyuri_fs.js" type="text/javascript"></script> -->
        <script type="text/javascript"> // universe function
            function scale_full(docobj, ratio=0){
                var w = window.innerWidth;
                var h = window.innerHeight;
                if(ratio>0) {
                    if(w/h > ratio) {
                        docobj.style.width  = h * ratio  + "px";
                        docobj.style.height = h + "px";
                    }
                    else {
                        docobj.style.width  = w  + "px";
                        docobj.style.height = w / ratio + "px";
                    }
                }
                else {
                    docobj.style.width  = w + "px";
                    docobj.style.height = h + "px";
                }
                return {w: docobj.style.width, h: docobj.style.height}
            }
            
            async function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async function send_worker(worker, data){
                worker.postMessage(data);
                return new Promise((res)=>{
                    worker.onmessage = (event)=>{
                        res(event.data);
                    };
                })
            };

            async function load_json(url){
                return new Promise((res)=>{
                    fetch(url).then((res)=>res.json())
                    .then((json)=>(res(json)));
                })
            }

            async function load_js(url)
            {
                var script = document.createElement('script');
                script.type = "text/javascript";
                script.src = url;
                document.getElementsByTagName("body")[0].appendChild(script);
                return new Promise((res)=>{
                    script.onload = () =>{
                        res(1);
                    }
                })
            }
        </script>
        <script> // onsyuri em function 
            function em_mkdirs(_FS, path)
            {
                var tmpdir="";
                var arr = path.split('/');
                for(i in arr)
                {
                    tmpdir += arr[i] +"/";
                    if(arr[i]=="") continue;
                    try{
                        _FS.mkdir(tmpdir);
                    }
                    catch{};
                }
            }

            function mount_onsgame(_FS, gamedir, files, urlbase="")
            {
                console.log("## onsyuri_fs: mount_onsgame", gamedir);
                for(i in files)
                {
                    var path = files[i].path;
                    var url = files[i].url;
                    var j = path.lastIndexOf("/");
                    var filename =path.substring(j+1);
                    var filedir = path.substring(0, j);
                    var basedir = gamedir + "/" + filedir;
                    if(url==undefined) url = urlbase + "/" + path;
                    else if (url.length==0) url = urlbase + "/" + path;
                    // console.log(path, url);
                    em_mkdirs(_FS, basedir);
                    _FS.createPreloadedFile(basedir, filename, url, true, false);
                }
            }

            function mount_onssave(_FS, _IDBFS, savedir)
            {
                console.log("## onsyuri_fs: mount_onssave", savedir);
                em_mkdirs(_FS, savedir);
                _FS.mount(_IDBFS, {}, savedir);
                _FS.syncfs(true, (err)=>{
                    if(err) console.log(err);
                });
            }

            function flush_save() // invoke in c code
            {
                onsyuri_module.FS.syncfs(false, (err)=>{
                    if(err) console.log(err);
                    else console.log("## onsyuri_fs: flush_save, sync finished");
                });
            }
        </script>
        <script type="text/javascript"> // onsyuri init    
            // init onsyuri_index and fs dir        
            const ONSYURI_FS_DIR = ""
            var onsyuri_index = {};
            var onsyuri_index_url = document.querySelector(
                'meta[onsyuri_index]').attributes.onsyuri_index.textContent;
           
            // init onsyuri_fs module
            // var onsyuri_fs_module = {};
            // onsyuri_fs_module.preRun = ()=>{
            //     console.log("## onsyuri_fs: preRun");
            //     var urlbase = window.location.href;
            //     urlbase = urlbase.substring(0, urlbase.lastIndexOf("/") + 1);
            //     mount_onsgame(onsyuri_fs_module.FS, onsyuri_index.gamedir, onsyuri_index.files, urlbase);
            //     mount_onssave(onsyuri_fs_module.FS, onsyuri_fs_module.IDBFS, onsyuri_index.savedir);
            // };
            
            // init onsyuri module
            var onsyuri_module  = {};
            onsyuri_module.canvas = (()=>{return document.getElementById('canvas');})();
            onsyuri_module.preRun = () => {
                console.log("## onsyuri: preRun");
                // onsyuri_module.FS.mkdir(ONSYURI_FS_DIR);
                // onsyuri_module.FS.mount(onsyuri_module.PROXYFS,  
                //     {root: "/", fs: onsyuri_fs_module.FS}, ONSYURI_FS_DIR);
                var urlbase = window.location.href;
                urlbase = urlbase.substring(0, urlbase.lastIndexOf("/") + 1);
                mount_onsgame(onsyuri_module.FS, onsyuri_index.gamedir, onsyuri_index.files, urlbase);
                mount_onssave(onsyuri_module.FS, onsyuri_module.IDBFS, onsyuri_index.savedir);
            };
            onsyuri_module.onRuntimeInitialized = () => {
                console.log("## onsyuri: onRuntimeInitialized");
                // console.log("## onsyuri: screen", screen_width, screen_height);
                // scale_full(canvas, 1280/720); // this function is in the ONScripter.cpp
            };
            
            // init window
            var strech_full = false;
            window.onresize = (event) =>{
                var canvas = document.getElementById('canvas');
                var ratio = strech_full ? window.innerWidth/window.innerHeight: canvas.width/canvas.height;
                scale_full(canvas, ratio);
            };
            window.onkeydown = (event) => {
                if(event.key=="F11"){
                    strech_full = !strech_full;
                    window.dispatchEvent(new Event('resize'));
                }
            }

            (async() => {
                onsyuri_index = await load_json(onsyuri_index_url);
                
                // invoke onsyuri_fs, for future workerfs, this can not sync idbfs through module
                // await onsyuri_fs(onsyuri_fs_module);
                // onsyuri_fs_module.callMain();

                // invoke onsyuri
                await onsyuri(onsyuri_module);
                // console.log("## onsyuri: gamedir", onsyuri_module.FS.readdir(ONSYURI_FS_DIR + onsyuri_index.gamedir));
                var args = [
                    "--root", ONSYURI_FS_DIR + onsyuri_index.gamedir, 
                    "--font",  ONSYURI_FS_DIR + onsyuri_index.gamedir + "/default.ttf", 
                    "--save-dir", onsyuri_index.savedir];
                args = args.concat(onsyuri_index.args);
                console.log("## onsyuri: args", args);
                onsyuri_module.callMain(args);
            })();
        </script>
    </body>
</html>