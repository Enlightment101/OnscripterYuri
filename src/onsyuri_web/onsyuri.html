<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta onsyuri_index="onsyuri_index.json">
        <title>Onscripter Yuri v0.6.3</title>
    </head>
    <body style="margin: 0 auto; background-color:black;">
        <canvas id="canvas" oncontextmenu="event.preventDefault()" style="margin: 0 auto; display: block;"></canvas>
        <script src="onsyuri.js" type="text/javascript"></script>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/BrowserFS/1.4.3/browserfs.min.js" type="text/javascript"></script> -->
        
        <script type="text/javascript"> // universe function
            function scale_full(docobj, ratio=0) {
                var w = window.innerWidth;
                var h = window.innerHeight;
                if(ratio>0) {
                    if(w/h > ratio) {
                        docobj.style.width  = h * ratio  + "px";
                        docobj.style.height = h + "px";
                    }
                    else {
                        docobj.style.width  = w  + "px";
                        docobj.style.height = w / ratio + "px";
                    }
                }
                else {
                    docobj.style.width  = w + "px";
                    docobj.style.height = h + "px";
                }
                return {w: docobj.style.width, h: docobj.style.height}
            }
            
            async function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async function send_worker(worker, data) {
                worker.postMessage(data);
                return new Promise((res)=>{
                    worker.onmessage = (event)=>{
                        res(event.data);
                    };
                })
            };

            async function load_json(url) {
                return new Promise((res)=>{
                    fetch(url).then((res)=>res.json())
                    .then((json)=>(res(json)));
                })
            }

            async function load_js(url) {
                var script = document.createElement('script');
                script.type = "text/javascript";
                script.src = url;
                document.getElementsByTagName("body")[0].appendChild(script);
                return new Promise((res)=>{
                    script.onload = () =>{
                        res(1);
                    }
                })
            }
        </script>
        
        <script type="text/javascript"> // onsyuri web function 
            function em_mkdirs(_FS, path) {
                var tmpdir="";
                var arr = path.split('/');
                for(i in arr)
                {
                    tmpdir += arr[i] +"/";
                    if(arr[i]=="") continue;
                    try{
                        _FS.mkdir(tmpdir);
                    }
                    catch{};
                }
            }

            // mount --gamedir other by preload or lazyload
            function mount_game(_FS, gamedir, files, urlbase="", lazyload=false) {
                console.log("## onsyuri_fs: mount_onsgame", gamedir);
                var filemap = {}
                
                if(gamedir[gamedir.length-1] =="/" ) 
                    gamedir=gamedir.substring(0, gamedir.length-1);

                for(i in files) {
                    var path = files[i].path;
                    var url = files[i].url;
                    var file_lazyload = files[i].lazyload;
                    var j = path.lastIndexOf("/");
                    var filename =path.substring(j+1);
                    var filedir = path.substring(0, j);
                    var basedir = gamedir + "/" + filedir;
                    if(basedir[basedir.length-1]!="/") basedir+="/";
                    if(url==undefined) url = urlbase + "/" + path;
                    else if (url.length==0) url = urlbase + "/" + path;
                    
                    // console.log(path, url, file_lazyload);
                    em_mkdirs(_FS, basedir);
                    if(file_lazyload==undefined) file_lazyload = lazyload;
                    if(file_lazyload){ // pay attension to the case sensitive!
                        var key = basedir + filename;
                        filemap[key.toLowerCase()] = {url: url, loaded:false};
                    }
                    else {
                        _FS.createPreloadedFile(basedir, filename, url, true, false);
                    }
                }
                return filemap;
            }

            // mount --gamedir using BrowserFS with lazyload, 
            // deprecated as sync block sound problems
            function mount_game2(_module, gamedir, lazyindex, urlbase) {
                console.log("## onsyuri_fs: mount_onsgame2", gamedir);
                var _FS=_module.FS;
                _module.addRunDependency("onsgamefs");
                
                var brewfs =  new BrowserFS.FileSystem.MountableFileSystem();
                var xhrfs = new BrowserFS.FileSystem.XmlHttpRequest(lazyindex, urlbase);
                window.xhrfs = xhrfs;
                window.brewfs = brewfs;
                brewfs.mount('/xhrfs', xhrfs);
                BrowserFS.initialize(brewfs);
                var BREWFS = new BrowserFS.EmscriptenFS(_module.FS, _module.PATH); 
                
                em_mkdirs(_FS, gamedir);
                _FS.mount(BREWFS, {root: "/xhrfs"}, gamedir);
                _module.removeRunDependency("onsgamefs")
            }

            // mount --savedir using IDBFS
            function mount_save(_FS, _IDBFS, savedir) {
                console.log("## onsyuri_fs: mount_onssave", savedir);
                em_mkdirs(_FS, savedir);
                _FS.mount(_IDBFS, {}, savedir);
                _FS.syncfs(true, (err)=>{
                    if(err) console.log(err);
                });
            }
        </script>
        
        <script type="text/javascript"> // onsyuri C interface of val or function
            
            // flush the savedir to IDFBFS for persistence
            function flush_save() { 
                g_onsyuri_module.FS.syncfs(false, (err)=>{
                    if(err) console.log(err);
                    else console.log("## onsyuri_fs: flush_save, sync finished");
                });
            }

            // fetch file from the remote server, and write them to local fs
            async function fetch_file(_FS, path, filemap) {
                var fnode = filemap[path];
                return new Promise((res)=>{
                    if(!fnode){
                        res(0);
                    }
                    else{
                        if(fnode.loaded) res(1);
                        fetch(fnode.url).then( (resp)=>{
                            return resp.arrayBuffer();
                        }).then((data)=>{
                            _FS.writeFile(path, new Uint8Array(data));
                            fnode.loaded = true;
                            res(1);
                        }).catch((err)=>{
                            console.log("## fetch_file ${path}", err);
                            res(-1);
                        })
                    }
                })
            }
    
            const ONSYURI_PREFIX = ""; // prefix for mount, not used 
            const ONSYURI_INDEX_URL = document.querySelector( // the url to load onsyuri_index.json
                'meta[onsyuri_index]').attributes.onsyuri_index.textContent;
            var g_onsyuri_index = {}; // onsyuri_index.json, game file index
            var g_onsyuri_filemap = {}; // filemap to record status of loaded files, used for lazyload
            var g_onsyuri_module  = {}; // onsyuri c module, FS and configure are here

        </script>

        <script type="text/javascript"> // onsyuri module
            g_onsyuri_module.canvas = (()=>{return document.getElementById('canvas');})();
            g_onsyuri_module.preRun = () => {
                console.log("## onsyuri: preRun");
                var lazyload = false;
                var urlbase = window.location.href;
                urlbase = urlbase.substring(0, urlbase.lastIndexOf("/") + 1);
                
                // lazyindex is deprecated as the sync sound problem
                if(g_onsyuri_index.lazyindex && g_onsyuri_index.lazyindex!=""){
                    mount_onsgame2(g_onsyuri_module, g_onsyuri_index.gamedir, 
                        g_onsyuri_index.lazyindex, urlbase);
                }
                else{
                    lazyload = g_onsyuri_index.lazyload||lazyload;
                    window.g_onsyuri_filemap = mount_game(
                        g_onsyuri_module.FS, g_onsyuri_index.gamedir, 
                        g_onsyuri_index.files, urlbase, lazyload
                    );
                }
                mount_save(g_onsyuri_module.FS, g_onsyuri_module.IDBFS, g_onsyuri_index.savedir);
            };
            g_onsyuri_module.onRuntimeInitialized = () => {
                console.log("## onsyuri: onRuntimeInitialized");
            };
            
            (async() => {
                g_onsyuri_index = await load_json(ONSYURI_INDEX_URL);
                await onsyuri(g_onsyuri_module);

                var args = [
                    "--root", ONSYURI_PREFIX + g_onsyuri_index.gamedir, 
                    "--font",  ONSYURI_PREFIX + g_onsyuri_index.gamedir + "/default.ttf", 
                    "--save-dir", g_onsyuri_index.savedir
                ];
                args = args.concat(g_onsyuri_index.args);
                console.log("## onsyuri: args", args);
                g_onsyuri_module.callMain(args);
            })();
        </script>

        <script type="text/javascript"> // onsyuri ui
            var g_strech_full = false;
            window.onresize = (event) =>{
                var canvas = document.getElementById('canvas');
                var ratio = g_strech_full ? window.innerWidth/window.innerHeight: canvas.width/canvas.height;
                scale_full(canvas, ratio);
            };
            window.onkeydown = (event) => {
                if(event.key=="F11"){
                    g_strech_full = !g_strech_full;
                    window.dispatchEvent(new Event('resize'));
                }
            }
        </script>
    </body>
</html>